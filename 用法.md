# MinerU 腾讯云 COS 集成使用指南

## 功能介绍
本项目在 MinerU 基础上集成了腾讯云 COS (Cloud Object Storage) 自动上传功能，在处理 PDF 文档时可以自动将提取的图片上传到 COS 存储桶。

## 快速开始

### 1. 配置腾讯云 COS
在 `config/cos_config.json` 文件中配置你的腾讯云信息：

```json
{
  "cos": {
    "secret_id": "AKIDxxxxxxxxxxxxxxxxxxxxxxxx",      // 替换为你的腾讯云 SecretId
    "secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxx",         // 替换为你的腾讯云 SecretKey  
    "bucket": "test-1234567890",                       // 替换为你的存储桶名称
    "region": "ap-guangzhou",                          // 替换为你的存储桶所在地区（如：ap-beijing, ap-shanghai）
    "prefix": "images/",                               // COS 存储路径前缀
    "enable_upload": true                              // 是否启用自动上传
  },
  "mineru": {
    "api_url": "http://localhost:8000",
    "output_dir": "./output"
  }
}
```

**获取腾讯云密钥：**
1. 登录[腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 访问管理 > 访问密钥 > API密钥管理
3. 创建或查看 SecretId 和 SecretKey

### 2. 使用 Docker 启动服务

```bash
# 启动 MinerU API 服务（包含 COS 自动上传功能）
docker-compose up -d

# 服务将在 8000 端口启动
# 访问地址：http://localhost:8000

# 查看服务日志
docker logs -f mineru-api-cos

# 停止服务
docker-compose down
```

**服务端口说明：**
- **8000**: MinerU API 服务端口，用于接收 PDF 处理请求

### 3. API 调用示例

#### 处理 PDF 文件
```bash
curl -X POST "http://localhost:8000/file_parse" \
  -F "files=@demo.pdf" \
  -F "backend=pipeline" \
  -F "return_md=true"
```

#### Python 调用示例
```python
import requests

url = "http://localhost:8000/file_parse"
files = {'files': open('demo.pdf', 'rb')}
data = {
    'backend': 'pipeline',
    'return_md': 'true'
}

response = requests.post(url, files=files, data=data)
result = response.json()
```

## 环境变量配置

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| `MINERU_ENABLE_COS` | 是否启用 COS 上传 | `true` |
| `MINERU_COS_CONFIG` | COS 配置文件路径 | `/app/config/cos_config.json` |

## Docker 镜像说明

本项目使用的 Docker 配置：
- 基础镜像：`mineru-sglang:latest`
- 自动安装 COS SDK：`cos-python-sdk-v5`
- 挂载本地修改的代码文件到容器中
- 支持 GPU 加速（需要 NVIDIA Docker）

## 功能特点

1. **自动上传**：处理 PDF 时自动将图片上传到 COS
2. **向后兼容**：不影响原有 MinerU 功能
3. **灵活配置**：通过环境变量控制是否启用
4. **容器化部署**：使用 Docker Compose 一键部署

## 文件结构
```
MinerU/
├── config/
│   └── cos_config.json          # COS 配置文件
├── mineru/
│   ├── cli/
│   │   └── common.py            # 修改：添加 COS 支持
│   └── data/data_reader_writer/
│       ├── __init__.py          # 修改：导入 COSDataWriter
│       └── cos_writer.py        # 新增：COS 上传实现
├── docker-compose.yml           # Docker 部署配置
├── Dockerfile                   # 基础镜像构建
└── run_api_with_cos.sh         # 启动脚本
```

## 注意事项

1. 确保腾讯云 COS 凭证正确配置
2. 存储桶需要有写入权限
3. 建议设置合适的存储桶生命周期策略
4. 处理大量文件时注意 COS 请求频率限制

## 故障排查

### 检查 COS 是否正常工作
```bash
# 查看容器日志
docker logs mineru-api-cos | grep -i cos

# 进入容器检查
docker exec -it mineru-api-cos bash
python3 -c "from mineru.data.data_reader_writer import COSDataWriter; print('COS module loaded')"
```

### 常见问题

1. **图片未上传到 COS**
   - 检查配置文件 `cos_config.json` 是否正确
   - 确认环境变量 `MINERU_ENABLE_COS=true`
   - 查看容器日志是否有错误信息

2. **容器启动失败**
   - 确保 Docker 和 Docker Compose 已安装
   - 检查端口 8000 是否被占用
   - 确认 GPU 驱动和 NVIDIA Docker 已安装（如使用 GPU）

## 更新日志

### 2025-08-07
- 集成腾讯云 COS 自动上传功能
- 添加 Docker Compose 部署支持
- 优化代码挂载方式，无需重新构建镜像