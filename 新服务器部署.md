# 新服务器部署指南

## 前置要求
- Docker 和 Docker Compose 已安装
- NVIDIA Docker runtime（如果使用 GPU）
- Git 已安装
- 腾讯云 COS 账号和密钥
- 至少 30GB 存储空间（用于模型下载）

## 部署步骤

### 1. 克隆代码仓库
```bash
git clone git@github.com:qq3829596922/MinerU_upload.git
cd MinerU_upload
```

### 2. 配置腾讯云 COS
创建并编辑 `config/cos_config.json` 文件：
```bash
mkdir -p config
vi config/cos_config.json
```

填入你的腾讯云信息（参考项目中的配置示例）。

### 3. 构建和启动服务

```bash
# 构建包含 COS 支持的镜像（首次构建需要下载模型，可能需要 10-20 分钟）
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker logs -f mineru-api-cos

# 测试服务是否正常
curl http://localhost:8000/health
```

### 4. 如果没有 GPU

如果服务器没有 GPU，需要修改 `docker-compose.yml`：
```yaml
# 注释掉 deploy 部分
# deploy:
#   resources:
#     reservations:
#       devices:
#         - driver: nvidia
#           device_ids: ["0"]
#           capabilities: [gpu]
```

## 常见问题解决

### 1. 镜像拉取失败
如果遇到 "pull access denied" 错误，说明镜像不存在或需要登录。

**解决方案**：
- 确保使用的是 `opendatalab/mineru:latest` 官方镜像
- 或者使用 Dockerfile 自行构建镜像

### 2. Python 路径问题
不同镜像的 Python 安装路径可能不同：
- 官方镜像通常在：`/opt/mineru/lib/python3.10/site-packages/`
- 自建镜像可能在：`/usr/local/lib/python3.12/dist-packages/`

如果遇到模块导入错误，需要：
```bash
# 进入容器查看实际路径
docker exec -it mineru-api-cos bash
find / -name "mineru" -type d 2>/dev/null

# 然后修改 docker-compose.yml 中的 cp 命令路径
```

### 3. 端口冲突
如果 8000 端口被占用：
```bash
# 检查端口占用
netstat -tlnp | grep 8000

# 修改 docker-compose.yml 中的端口映射
# 例如改为 8001:8000
```

## 验证部署

### 1. 检查服务状态
```bash
docker ps | grep mineru-api-cos
```

### 2. 测试 API
```bash
curl http://localhost:8000/health
```

### 3. 测试 PDF 处理
```bash
curl -X POST "http://localhost:8000/file_parse" \
  -F "files=@test.pdf" \
  -F "backend=pipeline" \
  -F "return_md=true"
```

## 更新代码

当需要更新代码时：
```bash
# 拉取最新代码
git pull

# 重启服务
docker-compose down
docker-compose up -d
```